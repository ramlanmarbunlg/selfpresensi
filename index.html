<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presensi Mandiri</title>

<link rel="icon" type="image/png" href="https://img.icons8.com/color/48/church.png">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
body{
background:linear-gradient(135deg,#0F2A44,#1FA4A9);
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
padding:15px;
}
.presensi-card{
background:white;
border-radius:20px;
box-shadow:0 20px 60px rgba(0,0,0,.3);
width:100%;
max-width:550px;
overflow:hidden;
}
.presensi-header{
background:linear-gradient(135deg,#0F2A44,#1FA4A9);
color:white;
padding:25px;
text-align:center;
}
.presensi-title{font-size:22px;font-weight:700;}
.presensi-body{padding:25px;}
#qr-reader{
width:100%;
min-height:300px;
border:2px dashed #0F2A44;
border-radius:15px;
overflow:hidden;
background:#f8f9fa;
}
.button-container{
display:flex;
gap:10px;
justify-content:center;
margin:15px 0;
}
.button-container .btn{flex:1;}
.result-badge{
padding:12px;
border-radius:10px;
margin-top:15px;
display:none;
}
.result-success{background:#d4edda;color:#155724;}
.result-error{background:#f8d7da;color:#721c24;}
.result-info{background:#d1ecf1;color:#0c5460;}
</style>
</head>

<body>

<div class="presensi-card">
<div class="presensi-header">
<div style="font-size:50px"><i class="fas fa-church"></i></div>
<div class="presensi-title">Gereja Pembaharuan Medan</div>
<div>Presensi Mandiri Jemaat</div>
</div>

<div class="presensi-body">

<div id="qr-reader"></div>

<div class="button-container">
<button class="btn btn-outline-dark" onclick="initQRScanner()">
<i class="fas fa-camera"></i> Aktifkan Kamera
</button>
<button class="btn btn-outline-info" onclick="flipCamera()">
<i class="fas fa-sync-alt"></i> Flip Kamera
</button>
</div>

<div id="result" class="result-badge">
<span id="resultMessage"></span>
</div>

<div class="mt-3">
<input type="text" id="manualId" class="form-control" placeholder="Masukkan ID manual">
<button class="btn btn-primary mt-2 w-100" onclick="manualCheckin()">Submit</button>
</div>

</div>
</div>

<script>

let html5QrCode=null;
let isScanning=false;
let lastScanned='';
let currentFacing="environment";

function initQRScanner(){
if(html5QrCode && isScanning){
html5QrCode.stop().then(()=>startScanner());
}else{
startScanner();
}
}

function startScanner(){
showResult('info','Mengakses kamera...');
html5QrCode=new Html5Qrcode("qr-reader");

const config={fps:10,qrbox:{width:250,height:250}};

html5QrCode.start(
{facingMode:currentFacing},
config,
onScanSuccess
).then(()=>{
isScanning=true;
showResult('success','Kamera aktif');
setTimeout(()=>document.getElementById('result').style.display='none',2000);
}).catch(err=>{
showResult('error','Tidak dapat akses kamera');
console.error(err);
});
}

function flipCamera(){
if(!isScanning){showResult('error','Aktifkan kamera dulu');return;}
currentFacing=currentFacing==="environment"?"user":"environment";
html5QrCode.stop().then(()=>startScanner());
}

function onScanSuccess(decodedText){
if(decodedText===lastScanned)return;
lastScanned=decodedText;
setTimeout(()=>lastScanned='',3000);
processPresensi(decodedText);
}

function manualCheckin(){
const id=document.getElementById('manualId').value.trim();
if(!id){showResult('error','Masukkan ID dulu');return;}
processPresensi(id);
}

function processPresensi(qrData){

showResult('info','Memproses...');

fetch("https://script.google.com/macros/s/AKfycbxIYCLN2mgsGqh_fDR0822WIfqMgs1ctMwOLJm-PJ923MwxBKWX5pgVIYHXQGzHooihid/exec",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({qrData:qrData})
})
.then(res=>res.json())
.then(response=>{
if(response.success){
showResult('success','✅ '+response.message);
document.getElementById('manualId').value='';
}else{
showResult('error','❌ '+response.message);
}
})
.catch(err=>{
console.error(err);
showResult('error','❌ Gagal koneksi server');
});

}

function showResult(type,message){
const el=document.getElementById('result');
const msg=document.getElementById('resultMessage');
el.className="result-badge result-"+type;
el.style.display="block";
msg.textContent=message;
}

</script>

</body>
</html>
